<!doctype html>
<html lang="en">
  <head>
    <script src="https://unpkg.com/@farcade/game-sdk@latest/dist/index.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Football Kickoff Return Game</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: #2b2b2b;
        overflow: hidden;
        touch-action: none;
        overscroll-behavior: none;
      }

      canvas {
        display: block;
        background-color: #107d27;
        width: 100vw;
        height: 100vh;
        touch-action: none;
        overscroll-behavior: none;
      }

      .stats {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        font-family: Clarendon, Rockwell, Impact, Georgia, serif;
        font-size: 14px;
        z-index: 10;
      }

      .restart-btn {
        font-family: Clarendon, Rockwell, Impact, Georgia, serif;
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ffcc00;
        border: none;
        padding: 12px 24px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        display: none;
      }

      .restart-btn:active {
        background-color: #ff9900;
      }

      #instructionsOverlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        font-family: Clarendon, Rockwell, Impact, Georgia, serif;
        font-size: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 20;
        padding: 0 20px;
      }

      #startButton {
        font-family: Clarendon, Rockwell, Impact, Georgia, serif;
        margin-top: 20px;
        padding: 12px 24px;
        background-color: #ffcc00;
        border: none;
        font-size: 18px;
        cursor: pointer;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>
    <div class="stats" id="statsDisplay">Touchdowns: 0</div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const statsDisplay = document.getElementById("statsDisplay");

      let gameLoopStarted = false;
      let gameOverHandled = false;

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      window.addEventListener("load", resetGame);

      const playerSize = 20;
      const defenderSize = 20;
      const ballSize = 15;
      let gameRunning = true;

      let playerX = canvas.width / 2,
        playerY = canvas.height - 50;
      let defenders = [];
      let kickerIndex = 1;
      let ballX = 0,
        ballY = 0;
      let ballCaught = false,
        yardsGained = 0,
        touchdowns = 0;
      let ballSpeedY = 0,
        ballSpeedX = 0;
      let bounceCount = 0;
      let bounceTimer = 0;
      let kickArcAmplitude = 0,
        kickArcFrequency = 0;
      let kickStartFrame = 0;

      let keys = { up: false, down: false, left: false, right: false };
      let touchStartX = 0,
        touchStartY = 0;
      let frameCount = 0;

      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowUp" || e.key === "w") keys.up = true;
        if (e.key === "ArrowDown" || e.key === "s") keys.down = true;
        if (e.key === "ArrowLeft" || e.key === "a") keys.left = true;
        if (e.key === "ArrowRight" || e.key === "d") keys.right = true;
      });

      document.addEventListener("keyup", (e) => {
        if (e.key === "ArrowUp" || e.key === "w") keys.up = false;
        if (e.key === "ArrowDown" || e.key === "s") keys.down = false;
        if (e.key === "ArrowLeft" || e.key === "a") keys.left = false;
        if (e.key === "ArrowRight" || e.key === "d") keys.right = false;
      });

      canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      });

      canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (gameRunning) {
          let touchX = e.touches[0].clientX;
          let touchY = e.touches[0].clientY;
          let deltaX = touchX - touchStartX;
          let deltaY = touchY - touchStartY;

          const threshold = 20;
          keys.up = deltaY < -threshold;
          keys.down = deltaY > threshold;
          keys.left = deltaX < -threshold;
          keys.right = deltaX > threshold;
        }
      });

      canvas.addEventListener("touchend", (e) => {
        e.preventDefault();
        keys.up = keys.down = keys.left = keys.right = false;
      });

      function updatePlayer() {
        if (keys.up && playerY > 0) playerY -= 3;
        if (keys.down && playerY < canvas.height - playerSize) playerY += 3;
        if (keys.left && playerX > 0) playerX -= 3;
        if (keys.right && playerX < canvas.width - playerSize) playerX += 3;
      }

      function updateDefenders() {
        const baseSpeed = 1.5;
        const speedBoost = 0.2 * touchdowns;

        defenders.forEach((defender, index) => {
          if (!ballCaught) {
            const stopLine = canvas.height * 0.4;
            if (defender.y < stopLine) {
              defender.y += 1;
            }
            return;
          }

          const dx = playerX - defender.x;
          const dy = playerY - defender.y;
          const distance = Math.max(1, Math.sqrt(dx * dx + dy * dy));
          const angle = Math.atan2(dy, dx);

          const offsetAngle = angle + (index - 1) * 0.4;
          const speed = baseSpeed + speedBoost;
          const targetX = playerX + Math.cos(offsetAngle) * 30;
          const targetY = playerY + Math.sin(offsetAngle) * 30;

          const moveX = ((targetX - defender.x) / distance) * speed;
          const moveY = ((targetY - defender.y) / distance) * speed;

          defender.x += moveX;
          defender.y += moveY;
        });
      }

      function updateBall() {
        if (!ballCaught) {
          ballY += ballSpeedY;
          ballX += ballSpeedX;

          if (kickArcAmplitude > 0) {
            const t = (frameCount - kickStartFrame) / 60;
            const arcOffset = kickArcAmplitude * Math.sin(kickArcFrequency * t);
            ballX += arcOffset;
          }

          if (ballX <= ballSize || ballX >= canvas.width - ballSize) {
            ballX = Math.max(ballSize, Math.min(canvas.width - ballSize, ballX));
            ballSpeedX = 0;
          }

          if (ballY >= canvas.height - 50 - ballSize) {
            ballY = canvas.height - 50 - ballSize;
          }

          if (bounceCount > 0 && bounceTimer <= 0) {
            ballSpeedY = -ballSpeedY * 0.6;
            bounceCount--;
            bounceTimer = 20;
          } else if (bounceTimer > 0) {
            bounceTimer--;
          } else {
            ballSpeedY += 0.5;
          }

          const dx = playerX - ballX;
          const dy = playerY - ballY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < playerSize + ballSize) {
            ballCaught = true;
          }
        }

        if (ballCaught) {
          ballX = playerX;
          ballY = playerY;
        }
      }

      function checkCollisions() {
        if (!ballCaught) return;
        defenders.forEach((defender) => {
          if (Math.abs(defender.x - playerX) < defenderSize && Math.abs(defender.y - playerY) < defenderSize) {
            gameRunning = false;
            showGameOver();
          }
        });
      }

      function showTouchdown() {
        if (!ballCaught) return;
        if (window.FarcadeSDK) window.FarcadeSDK.singlePlayer.actions.hapticFeedback();
        touchdowns++;
        yardsGained += canvas.height - playerY;
        showParticleEffect(playerX, playerY);
        resetGame();
      }

      function showGameOver() {
        if (gameOverHandled) return;
        gameOverHandled = true;
        if (window.FarcadeSDK) {
          window.FarcadeSDK.singlePlayer.actions.gameOver({ score: touchdowns });
        }
      }

      function resetGame() {
        playerX = canvas.width / 2;
        playerY = canvas.height - 50;
        ballCaught = false;

        kickerIndex = Math.floor(Math.random() * 3);
        defenders = [
          { x: canvas.width / 4, y: 50 },
          { x: canvas.width / 2, y: 50 },
          { x: (canvas.width * 3) / 4, y: 50 },
        ];

        const kicker = defenders[kickerIndex];
        ballX = kicker.x;
        ballY = kicker.y;

        ballSpeedY = (3 + Math.random() * 2) * 0.7;
        ballSpeedX = (Math.random() - 0.5) * 1.05;
        if (ballSpeedY < 0) ballSpeedY *= -1;

        bounceCount = Math.floor(Math.random() * 3);
        bounceTimer = 0;

        kickArcAmplitude = Math.random() < 0.5 ? 0 : 5 + Math.random() * 10;
        kickArcFrequency = 3 + Math.random() * 2;
        kickStartFrame = frameCount;

        gameRunning = true;
        gameOverHandled = false;
      }

      function showParticleEffect(x, y) {
        // Placeholder
      }

      function renderGame() {
        frameCount++;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.strokeStyle = "white";
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(0, 50);
        ctx.lineTo(canvas.width, 50);
        ctx.moveTo(0, canvas.height - 50);
        ctx.lineTo(canvas.width, canvas.height - 50);
        ctx.stroke();

        ctx.fillStyle = "white";
        ctx.font = "20px Clarendon, Rockwell, Impact, Georgia, serif";
        ctx.textAlign = "center";
        ctx.fillText("A7FL.com 3 on 1 Throw-off Return", canvas.width / 2, canvas.height - 20);
        ctx.fillText("END ZONE", canvas.width / 2, 30);

        if (gameRunning) {
          updatePlayer();
          updateDefenders();
          updateBall();
          checkCollisions();

          statsDisplay.innerText = `Touchdowns: ${touchdowns}`;

          ctx.fillStyle = "blue";
          ctx.fillRect(playerX - playerSize * 0.75, playerY - 6, playerSize * 1.5, playerSize * 2);

          ctx.fillStyle = "black";
          ctx.beginPath();
          ctx.arc(playerX, playerY - 6 - 15, 15, 0, Math.PI * 2);
          ctx.fill();

          ctx.fillStyle = "black";
          ctx.fillRect(playerX - playerSize * 0.75 - playerSize / 2, playerY - 6, 8, 24);
          ctx.fillRect(playerX + playerSize * 0.75, playerY - 6, 8, 24);
          ctx.fillRect(playerX - 10, playerY - 6 + playerSize * 2, 8, 24);
          ctx.fillRect(playerX + 2, playerY - 6 + playerSize * 2, 8, 24);

          defenders.forEach((defender) => {
            ctx.fillStyle = "red";
            ctx.fillRect(defender.x - defenderSize * 0.75, defender.y - 6, defenderSize * 1.5, defenderSize * 2);

            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(defender.x, defender.y - 6 - 15, 15, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillRect(defender.x - defenderSize * 0.75 - defenderSize / 2, defender.y - 6, 8, 24);
            ctx.fillRect(defender.x + defenderSize * 0.75, defender.y - 6, 8, 24);
            ctx.fillRect(defender.x - 10, defender.y - 6 + defenderSize * 2, 8, 24);
            ctx.fillRect(defender.x + 2, defender.y - 6 + defenderSize * 2, 8, 24);
          });

          ctx.fillStyle = "white";
          ctx.beginPath();
          ctx.ellipse(ballX, ballY, ballSize, ballSize + 5, 0, 0, Math.PI * 2);
          ctx.fill();

          if (playerY <= 50) {
            showTouchdown();
          }
        }

        requestAnimationFrame(renderGame);
      }

      window.addEventListener("load", () => {
        const startButton = document.getElementById("startButton");
        startButton.addEventListener("click", () => {
          document.getElementById("instructionsOverlay").style.display = "none";
          resetGame();

          if (!gameLoopStarted) {
            renderGame();
            gameLoopStarted = true;
          }

          if (window.FarcadeSDK) {
            window.FarcadeSDK.singlePlayer.actions.ready();
          }
        });

        if (window.FarcadeSDK) {
          window.FarcadeSDK.on("play_again", () => {
            touchdowns = 0;
            yardsGained = 0;
            gameRunning = true;
            resetGame();
          });

          window.FarcadeSDK.on("toggle_mute", (data) => {
            // Mute/unmute game audio
          });
        }
      });
    </script>

    <div id="instructionsOverlay">
      <div>How many touchdowns can you score?<br />Use arrow keys or hold down and drag on mobile.</div>
      <button id="startButton">Press Start</button>
    </div>
  </body>
</html>
